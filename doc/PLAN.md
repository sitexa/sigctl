# 交通信号机控制系统基础方案 v1（EM928x & 内部协议版）

> 目标：在嵌入式 Linux 主控板（EM928x）+ 灯控板（驱动板）上，实现可投入现场联调的最小可用系统（MVP）：双相位固定配时、CAN 通讯、失联安全降级、面板交互与运维自启；并以内部协议（0xA\*/0xB\*/0xC\*/0xD\*）为标准对接。

---

## 版本与范围

* **版本**：v1（适配 EM928x & 内部协议）
* **路口范围**：单路口，双相位（南北直行 / 东西直行），后续可扩展左转/行人专用。
* **控制能力**：绿/黄/全红时序与相序切换；行人/车检输入预留；面板信息同步。
* **通信**：主控↔灯控板 **CAN 2.0A（11-bit，默认 250 kbps）**；主控↔面板 **串口 COM5 115200**。
* **安全**：主控失联/异常→灯控独立黄闪；相位切换强制全红；冲突互锁以硬件/固件为主，软件附加保护。

---

## 1. 硬件与拓扑

* **主控板**：EM928x（Linux），带 CAN 控制器与收发器，或经 MCP2515（SPI）+ TJA1050/1042 实现 CAN；提供多个串口（COM1..5）。
* **灯控板**：执行红/黄/绿输出；内置“失联黄闪”和“冲突互锁”；强电侧由灯控板完成，主控仅弱电与协议控制。
* **输入**：行人按钮、车检器、门开关、电源故障、灯回路电流/灯丝故障（可选）。
* **CAN 布线**：总线型，双端各 **120 Ω** 终端；CAN\_H/CAN\_L 双绞线，分支（stub）< 30 cm；必要时采用隔离收发器与共模扼流圈。

---

## 2. Bring-up（EM928x & SocketCAN）

### 2.1 开机配置与应用自启

* 使用 **`userinfo.txt`** 进行网络、NFS 与自启程序配置（示例见附录 B）。
* 将可执行程序部署到 `/mnt/nandflash/sigctl`（或 NFS 映射路径），在 `userinfo.txt` 中设置：`Name="/mnt/nandflash/sigctl"`。
* 调试阶段建议启用 NFS：PC 端提供 NFS 共享，主控开机自动挂载至 `/mnt/nfs`，实现“PC 编译、主控运行”。
* 主控底板“调试/运行模式”跳线：开发期用“调试”，出厂切“运行”以启用自启。

### 2.2 CAN 设备与速率

* 若采用 MCP2515：开启 SPI，加载设备树 overlay（树莓派示意）并重启后得到 `can0`。
* 配置速率与自动恢复：

```
sudo ip link set can0 up type can bitrate 250000 restart-ms 100
ip -details -brief link show can0
```

* 调试工具：`can-utils`（`candump can0` 监听；`cansend can0 <id>#<data>` 发送）。

### 2.3 串口映射（示例）

* **COM5**：面板，`/dev/ttyS2`（根据实际映射调整），`115200 8N1`。
* 其他串口（COM1/2/3/4）后续按阶段启用（遥控、底板 MCU、按键板、车检通讯等）。

---

## 3. 应用层协议（内部协议对接）

> 载荷统一采用：**首字节=命令字，尾字节固定 `0xED`**，中间为数据字段；CAN 层使用 11-bit 标识符。多板场景下采用“基址 + 节点号”的 ID 规划。

### 3.1 CAN 帧 ID（单灯控板示例）

* **主→灯（下行）**：`0x100`
* **灯→主（上行）**：`0x180`

> 若现场已有固定 ID，按现场配置覆盖即可。

### 3.2 下行命令（主→灯，0xA\*）

| 命令     | 含义      | 数据载荷（除尾字节 0xED）                     | 说明                                    |
| ------ | ------- | ----------------------------------- | ------------------------------------- |
| `0xA0` | 方案/阶段下发 | `标识, [阶段通道位图_HI,LO], 绿时_1B`         | 阶段号 1–16；通道 1–16 位图；单位 s              |
| `0xAA` | 灯组点控    | `通道(1..64/0xFF全部), 状态(0红/1黄/2绿/3灭)` | 直接控制单灯/全灯                             |
| `0xAB` | 心跳      | `0xAB`                              | 建议 100 ms 周期                          |
| `0xAC` | 重启驱动板   | `0xAC`                              | 维护用                                   |
| `0xAD` | 故障黄闪    | `0xAD`                              | 请求进入独立黄闪                              |
| `0xAE` | 正常恢复    | `0xAE`                              | 退出黄闪恢复正常                              |
| `0xAF` | 默认绿灯时间  | `NS_G, EW_G`                        | ≤10 则按黄闪模式理解                          |
| `0xA7` | 故障时控制方式 | `方式`                                | 00 独黄；01 备用方案；02 立即独黄；03 立即备用；04 立即恢复 |

> 以上命令均以 `0xED` 结尾；必要时可在应用层增加“序号”与“校验”字段以增强鲁棒性。

### 3.3 上行命令（灯→主，0xB\*）

| 命令     | 含义         | 数据载荷                  | 说明                            |
| ------ | ---------- | --------------------- | ----------------------------- |
| `0xB1` | 驱动板状态      | `板号(1..16), 状态`       | 0未装/1启动/2正常/3故障黄闪/4独黄灭/5独黄控制  |
| `0xB2` | 灯组状态       | `板号, [黄绿位图], [红位图]`   | 1..4 路位图上报                    |
| `0xB3` | 灯故障        | `标志, 通道, 故障类型`        | 标志 00恢复/01故障；类型含不亮/同亮/误亮等     |
| `0xB4` | CAN 故障触发独黄 | `状态, 故障点`             | 00 正常/01 故障；故障点 0 主控/1..16 驱动 |
| `0xB6` | 电压信息       | `0x01, 电压(2B,BE)`     | 供电监测                          |
| `0xB8` | 版本信息       | `板号, 年, 月, 日, 版1, 版2` | 版本追溯                          |

### 3.4 面板（COM5，0xC\*/0xD\*）

* 常见下行：`0xC1` 当前控制信息、`0xC2` 方案信息、`0xC4` 故障信息、`0xC5` IP 信息、`0xC6` 系统时间、`0xC7` 相位参数。
* 典型上行：`0xD0` 面板请求、`0xD3/D6/D7` 修改 IP/时间/参数等。

---

## 4. 心跳与降级策略

* **主控心跳**：`0xAB AB ED`，**100 ms 周期**发送。
* **失联判据**：灯控板维护 500 ms 计时器；该时间窗内未收到有效下行（或心跳失步）→ **自动进入独立黄闪**；收到有效帧后立即退出黄闪并上报 `0xB1/0xB2`。
* **主控动作**：检测到 `0xB4` 或长时间无上行、回读异常时，主动下发 `0xAD`（请求黄闪），并记录告警；恢复后下发 `0xAE`。
* **上电/恢复流程**：默认全红 → 心跳建立 → 下发初始相位（或默认绿时 `0xAF`）→ 进入正常循环。

---

## 5. 控制逻辑（固定配时 MVP）

### 5.1 参数（示例）

* 绿（G）：每向 20 s；黄（Y）：3 s；全红（AR）：1 s（以规范与设计为准可调）。

### 5.2 相序

```
NS_G(tg) → NS_Y(ty) → AR(ta) → EW_G(tg) → EW_Y(ty) → AR(ta) → 循环
```

### 5.3 安全约束

* 任意时刻仅允许一个方向为绿/黄；相向切换必须经历全红。
* 冲突互锁与失联黄闪优先由灯控板硬件/固件保证，主控软件附加校验与降级。

---

## 6. 软件架构与代码骨架

### 6.1 模块划分

* **io-can**：SocketCAN 读写与编解码（`0xA*` 下行、`0xB*` 上行）；周期心跳；500 ms 失联检测；事件队列输出。
* **control-core**：相序状态机（固定配时→感应/协调可扩展）；只产出“灯色意图”，不直接做 IO。
* **ui-panel**：COM5 面板协议（`0xC*/0xD*`）；显示/参数/告警；注意不阻塞控制线程。
* **cfg/log**：配置热加载（可选）、滚动日志、黑匣子事件。

### 6.2 配置示例（`config.yaml`）

```yaml
can:
  iface: "can0"
  bitrate: 250000
ids:
  down: 0x100
  up:   0x180
serial:
  panel: "/dev/ttyS2"
timing:
  g: 20000
  y: 3000
  ar: 1000
```

### 6.3 关键代码片段（Rust 思路）

```rust
// 下行：心跳、点控、方案
enum Dn { Scheme=0xA0, Lamp=0xAA, HB=0xAB, Rst=0xAC, Fail=0xAD, Res=0xAE, DefG=0xAF, FailMode=0xA7 }
fn pack_lamp(ch:u8, state:u8) -> [u8;4] { [Dn::Lamp as u8, ch, state, 0xED] }
fn pack_hb() -> [u8;3] { [Dn::HB as u8, 0xAB, 0xED] }

// 上行解析：按首字节分派 0xB1/0xB2/0xB3/0xB4/0xB6/0xB8，校尾字节 0xED
// control-core 仅输出 Group{ns_r/ns_y/ns_g, ew_r/ew_y/ew_g} 意图，由 io-can 统一映射为 0xAA/0xA0。
```

---

## 7. 测试计划

### 7.1 台架（CAN）

1. Bring-up：`ip link set can0 up type can bitrate 250000 restart-ms 100`；`candump can0` 监听。
2. 运行主控程序：应每 **100 ms** 看到下发 `0xAB`；阶段切换时出现 `0xAA/0xA0`。
3. 手工验证：

   * 点控：`cansend can0 100#AA0102ED`（通道1置绿）/`cansend can0 100#AAFF00ED`（全部置红）。
   * 方案：按阶段位图与绿时构造 `0xA0` 帧发送，观察驱动回读 `0xB2`。
4. 断总线 ≥ 0.5 s：灯控进入独黄，或上行 `0xB4` 告警；恢复后首帧退出黄闪。

### 7.2 面板（COM5）

* 串口 115200 连接，周期下发 `0xC1/0xC2/0xC6`；触发故障时下发 `0xC4`，确认显示一致。

### 7.3 验收

* 24h 连续运行无冲突与异常降级；
* 断连/恢复各 50 次均如期黄闪/恢复；
* 面板显示与实际一致；
* 启动自启可靠，升级/回滚可用，日志完整。

---

## 8. 运维与升级

* **自启**：通过 `userinfo.txt` 配置自启路径与网络；断电重启自动拉起；运行模式跳线按出厂要求设置。
* **日志**：事件/故障/参数变更记录到 `/mnt/nandflash/logs` 或 NFS；定期轮转。
* **升级**：推荐“双镜像 + 回滚”；升级期间保持全红或由灯控独黄；升级后运行自检。

---

## 附录 A：内部协议命令表（摘要）

### A.1 主→灯（0xA\*）

| Cmd  | 名称     | 数据                            | 备注                             |
| ---- | ------ | ----------------------------- | ------------------------------ |
| 0xA0 | 方案/阶段  | `ID, 通道位图_HI, 通道位图_LO, 绿时`    | 阶段号与灯通道批量设定                    |
| 0xAA | 灯组点控   | `通道(1..64/0xFF), 状态(0/1/2/3)` | 0红/1黄/2绿/3灭                    |
| 0xAB | 心跳     | `0xAB`                        | 100 ms 周期                      |
| 0xAC | 重启驱动板  | `0xAC`                        | 维护                             |
| 0xAD | 故障黄闪   | `0xAD`                        | 请求进入独黄                         |
| 0xAE | 正常恢复   | `0xAE`                        | 退出独黄                           |
| 0xAF | 默认绿灯时间 | `NS_G, EW_G`                  | ≤10 视为黄闪模式                     |
| 0xA7 | 故障控制方式 | `方式`                          | 00独黄/01备用/02立即独黄/03立即备用/04立即恢复 |

> 所有帧以 `0xED` 结尾。

### A.2 灯→主（0xB\*）

| Cmd  | 名称         | 数据                    | 备注                           |
| ---- | ---------- | --------------------- | ---------------------------- |
| 0xB1 | 板状态        | `板号, 状态`              | 0未装/1启动/2正常/3故障黄闪/4独黄灭/5独黄控制 |
| 0xB2 | 灯组状态       | `板号, [黄绿位图], [红位图]`   | 回读核对                         |
| 0xB3 | 灯故障        | `标志, 通道, 故障类型`        | 00恢复/01故障；类型见细表              |
| 0xB4 | CAN 故障触发独黄 | `状态, 故障点`             | 00正常/01故障；故障点 0主控/1..16驱动    |
| 0xB6 | 电压信息       | `0x01, 电压(2B,BE)`     | 供电监测                         |
| 0xB8 | 版本         | `板号, 年, 月, 日, 版1, 版2` | 追溯                           |

### A.3 面板（COM5，0xC\*/0xD\*，摘录）

| Cmd        | 方向   | 名称     | 说明         |
| ---------- | ---- | ------ | ---------- |
| 0xC1       | 主→面板 | 当前控制信息 | 相位、剩余时间、模式 |
| 0xC2       | 主→面板 | 方案信息   | 当前方案/阶段    |
| 0xC4       | 主→面板 | 故障信息   | 灯故障/总线故障等  |
| 0xC5       | 主→面板 | IP 信息  | 地址/掩码/网关   |
| 0xC6       | 主→面板 | 系统时间   | 同步面板时钟     |
| 0xC7       | 主→面板 | 相位参数   | 参数下发/展示    |
| 0xD0       | 面板→主 | 请求     | 拉取当前/确认动作  |
| 0xD3/D6/D7 | 面板→主 | 修改     | IP/时间/参数修改 |

---

## 附录 B：示例 `userinfo.txt`

```
[NET]
IP=192.168.1.50
MASK=255.255.255.0
GW=192.168.1.1

[NFS]
Enable=1
Server=192.168.1.10
Remote=/export/sigctl
Local=/mnt/nfs

[APP]
Name=/mnt/nandflash/sigctl
Args=
```

---

## 附录 C：通道与接口映射（示例模板）

```
# 输出通道映射（按现场调整）
1 NS_R   2 NS_Y   3 NS_G
4 EW_R   5 EW_Y   6 EW_G
...

# 串口映射
COM5 => /dev/ttyS2 (Panel, 115200 8N1)
COM2 => /dev/ttyS1 (MCU,   115200 8N1)
COM1/3/4 视现场定义
```

---

## 附录 D：失联与恢复时序（ASCII）

```
主控:  --AB--AB--AB--AA/A0--AB--AB--AB--AB--X(断链)--(>500ms)--AE--AA/A0--AB--
灯控:  <----正常输出/回读----->            [独立黄闪]        <---恢复正常---->
```

---

### 清单式落地步骤（摘要）

1. 完成 EM928x 自启配置（附录 B），bring-up `can0`；
2. 部署 `sigctl`（io-can/control-core/ui-panel），启动后观察 100 ms 心跳与阶段下发；
3. 台架验证点控/方案与失联黄闪；
4. 面板联调 `0xC1/0xC2/0xC4/0xC6`；
5. 现场联调与验收（7.3），进入运维与版本管理。
