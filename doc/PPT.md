交通信号控制系统开发方案
1. 项目概述
目标： 基于 英利EM928x嵌入式Linux平台，开发一套稳定、可靠的交通信号控制系统，实现单路口双相位固定配时控制，并以内部通讯协议为标准，快速达到现场联调状态（MVP）。

核心硬件： 英利 EM928x Linux工控主板

核心协议： 内部自定义CAN总线与串口协议

关键特性：

固定配时控制

CAN总线通信

通信中断安全降级

面板交互与自启动运维

!(https://placehold.co/600x300/7c3aed/ffffff?text=EM928x+%E5%B5%8C%E5%85%A5%E5%BC%8F%E4%B8%BB%E6%8E%A7%E6%9D%BF)

2. 系统架构与硬件拓扑
系统架构图：

主控板 (EM928x): 负责核心逻辑控制、协议处理、状态监控。

灯控板 (驱动板): 执行信号灯的红/黄/绿切换，硬件实现冲突互锁与故障检测。

人机交互 (面板): 通过串口与主控板连接，用于显示系统状态、接收手动干预。

输入设备: 预留行人按钮、车辆检测器接口。

硬件拓扑：

主控板 ↔ 灯控板：CAN总线 连接，总线型拓扑，双端配置120Ω终端电阻。

主控板 ↔ 面板：串口 (COM5) 连接。

!(https://placehold.co/800x400/f97316/ffffff?text=%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E4%B8%8E%E7%A1%AC%E4%BB%B6%E6%8B%93%E6%89%91)

3. 软件开发环境搭建
参考《英利Linux工控主板使用必读》，搭建高效的开发与调试环境。

开发主机： PC (Windows/Linux)

IDE： Eclipse

交叉编译工具链： Sourcery G++ Lite for ARM GNU/Linux

程序部署与调试：

NFS挂载： 通过网络文件系统，实现“PC端编译、主控板运行”，极大提升调试效率。

userinfo.txt 配置： 用于设置主控板IP地址、NFS路径和开机自启动程序。

超级终端： 通过串口连接，以 115200 波特率查看系统日志和进行命令行操作。

4. 核心通讯协议 - CAN总线 (主控 ↔ 灯控)
基于《内部通讯协议》文档，定义主控板与灯控板之间的通信。

物理层： CAN 2.0A, 11-bit ID, 速率 250 kbps

ID 分配 (示例):

主控 → 灯控 (下行): 0x100

灯控 → 主控 (上行): 0x180

关键指令 (数据帧以 0xED 结尾):

下行 (0xA*):

0xA0: 方案/阶段下发 (核心控制指令)

0xAA: 灯组点控 (手动干预)

0xAB: 心跳信号 (100ms周期)

0xAD: 请求故障黄闪

0xAE: 请求恢复正常

上行 (0xB*):

0xB1: 灯控板状态上报

0xB3: 灯故障上报

0xB4: CAN通讯故障上报

5. 核心通讯协议 - 串口 (主控 ↔ 面板)
物理端口： COM5 (设备文件路径如 /dev/ttyS2)

通信参数： 115200, 8N1

主要功能：

主控 → 面板 (0xC*):

0xC1: 上报当前控制信息 (相位、倒计时等)

0xC4: 上报故障信息

0xC6: 同步系统时间

面板 → 主控 (0xD*):

0xD0: 请求各类信息

0xD3/D6/D7: 修改IP、时间、相位等参数

6. 控制逻辑与安全策略
控制模型： 双相位固定配时 (南北直行 / 东西直行)

相位时序 (示例):
南北绿灯 (20s) → 南北黄灯 (3s) → 全红 (1s) → 东西绿灯 (20s) → 东西黄灯 (3s) → 全红 (1s) → 循环

安全策略：

心跳机制： 主控每 100ms 发送一次CAN心跳 (0xAB)。

失联降级： 灯控板若 500ms 内未收到主控有效CAN帧，自动切换至独立黄闪模式。

冲突互锁： 优先由灯控板硬件/固件保证，主控软件层面附加校验。

相位切换保护： 任何相位切换必须经过全红阶段。

7. 软件架构设计
采用模块化、多线程的设计，确保系统的实时性与稳定性。

io-can 模块： 独立线程，负责CAN总线数据的收发、心跳维持和连接状态检测。

control-core 模块： 核心控制逻辑，实现相序状态机切换，生成灯色控制意图。

ui-panel 模块： 独立线程，负责与面板的串口异步通讯，处理显示更新与参数修改请求。

cfg/log 模块： 负责配置文件解析和滚动日志记录。

// 伪代码示例
fn main() {
    // 初始化配置、日志
    let config = load_config("config.yaml");

    // 启动CAN通信线程
    let can_handle = thread::spawn(move || can_bus_task());
    
    // 启动面板通信线程
    let panel_handle = thread::spawn(move || panel_serial_task());

    // 主线程运行控制逻辑
    control_logic_task();
}

8. 开发与测试计划
阶段一：环境搭建与Bring-up

完成EM928x主板的系统配置、NFS挂载及自启动设置。

使用 can-utils 工具调通CAN接口，确认收发正常。

阶段二：协议栈与核心逻辑开发

实现CAN和串口协议的完整编解码。

开发固定配时控制的状态机及安全逻辑。

阶段三：台架测试

连接真实的灯控板与面板，或使用模拟器进行测试。

重点测试： 心跳、失联黄闪、故障上报、恢复流程。

阶段四：现场联调与验收

进行 24小时 连续运行稳定性测试。

反复进行 断电、断链恢复 测试，确保安全策略可靠。

9. 运维与升级方案
自启动与守护：

通过 userinfo.txt 配置应用自启动。

可增加守护进程(Watchdog)，监控主程序状态，在异常时自动重启。

日志系统：

关键事件、故障、参数变更均记录日志，存储于 /mnt/nandflash/logs，并定期轮转。

软件升级：

通过 NFS或U盘 进行应用程序的远程或本地升级。

建议采用双备份机制，升级失败可快速回滚至上一稳定版本。

10. Q & A
提问与交流